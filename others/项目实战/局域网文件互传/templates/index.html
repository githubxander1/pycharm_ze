<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件上传与管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>上传文件</h1>
    <div>
    <div>
    <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form" class="upload-form">
        <input type="file" name="file">
        <input type="submit" value="上传文件" class="upload-button">
    </form>
    <form action="{{ url_for('upload_text') }}" method="post" id="text-form" class="upload-form">
        <textarea name="text" rows="4" cols="50" placeholder="输入文本内容"></textarea>
        <input type="submit" value="上传文本" class="upload-button">
    </form>
    </div>
    <div id="upload-result" class="upload-result"></div>
    <div class="files-list" id="files-list">
        <ul id="file-list">
        </ul>
        <p class="no-files" id="no-files">暂无文件</p>
    </div>
    <script>
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault(); // 阻止表单默认提交行为
            const formData = new FormData(event.target);
            fetch('{{ url_for("upload_file") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('upload-result').textContent = '文件上传成功';
                    updateFileList();
                } else {
                    document.getElementById('upload-result').textContent = '文件上传失败';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('upload-result').textContent = '文件上传失败';
            });
        });

        document.getElementById('text-form').addEventListener('submit', function(event) {
            event.preventDefault(); // 阻止表单默认提交行为
            const formData = new FormData(event.target);
            fetch('{{ url_for("upload_text") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('upload-result').textContent = '文本上传成功';
                    updateFileList();
                } else {
                    document.getElementById('upload-result').textContent = '文本上传失败';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('upload-result').textContent = '文本上传失败';
            });
        });

        function addTextFileInput() {
            const textInput = document.querySelector("#text-form input[type='text']");
            if (textInput.style.display === "none") {
                textInput.style.display = "block";
            } else {
                textInput.style.display = "none";
            }
        }

        function updateFileList() {
            fetch('{{ url_for("get_files") }}')
                .then(response => response.json())
                .then(data => {
                    const fileList = document.getElementById('file-list');
                    const noFiles = document.getElementById('no-files');
                    fileList.innerHTML = '';
                    noFiles.style.display = 'none';

                    if (data.files.length === 0) {
                        noFiles.style.display = 'block';
                    } else {
                        data.files.forEach(file => {
                            const listItem = document.createElement('li');
                            const link = document.createElement('a');
                            link.href = `/uploads/${encodeURIComponent(file)}`;
                            link.textContent = file;
                            link.target = "_blank"; // 打开新标签页查看文件
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = '删除';
                            deleteButton.onclick = () => deleteFile(file);

                            listItem.appendChild(link);
                            listItem.appendChild(deleteButton);
                            fileList.appendChild(listItem);
                        });
                    }
                });
        }

        function deleteFile(filename) {
            if (confirm("确定要删除此文件吗？")) {
                fetch(`/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        alert('删除成功');
                        updateFileList();
                    } else {
                        alert('删除失败');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // 初始化文件列表
        updateFileList();

        // 每隔 2 秒更新一次文件列表
        setInterval(updateFileList, 2000);
    </script>
    </div>
</body>
</html>